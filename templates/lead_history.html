{% extends "dashboard_base.html" %}
{% block title %}Lead History{% endblock %}
{% block content %}
<div class="bg-[#0D1321] min-h-screen text-white p-8">
    <h1 class="text-4xl font-bold text-center mb-12">Your Lead History</h1>
    <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 max-w-6xl mx-auto">
        <!-- Filters and Search -->
        <div class="flex flex-wrap gap-4 mb-4">
            <select id="timeFilter" class="bg-[#0D1321] border border-[#7B00FF] px-4 py-2 rounded-lg text-sm hover:bg-[#7B00FF] text-[#A1A9B8]" onchange="filterLeads()">
                <option value="all">All Time</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
            <select id="statusFilter" class="bg-[#0D1321] border border-[#7B00FF] px-4 py-2 rounded-lg text-sm hover:bg-[#7B00FF] text-[#A1A9B8]" onchange="filterLeads()">
                <option value="all">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Emailed">Emailed</option>
                <option value="Replied">Replied</option>
            </select>
            <input type="text" id="searchInput" placeholder="Search by name/email" class="bg-[#0D1321] border border-[#7B00FF] px-4 py-2 rounded-lg text-sm text-[#A1A9B8] flex-grow md:flex-grow-0" oninput="filterLeads()">
        </div>

        <!-- Desktop Table -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-left text-[#A1A9B8] text-sm">
                <thead>
                    <tr class="border-b border-[#7B00FF]">
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortTable(0)">Name ↕</th>
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortTable(1)">Email ↕</th>
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortTable(2)">Source ↕</th>
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortTable(3)">Score ↕</th>
                        <th class="p-3">Status</th>
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortTable(5)">Date Added ↕</th>
                        <th class="p-3">Notes</th>
                        <th class="p-3">Outcome</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in leads %}
                    <tr class="border-b border-[#7B00FF] animate-fade-in" data-score="{{ lead.score }}" data-date="{{ lead.date_added }}" style="animation-delay: {{ loop.index0 * 0.1 }}s">
                        <td class="p-3">{{ lead.name }}</td>
                        <td class="p-3">{{ lead.email }}</td>
                        <td class="p-3">{{ lead.source }}</td>
                        <td class="p-3 {% if lead.score > 75 %}text-[#7B00FF]{% endif %}">{{ lead.score }}</td>
                        <td class="p-3">{{ lead.status }}</td>
                        <td class="p-3">{{ lead.date_added }}</td>
                        <td class="p-3">{{ lead.notes }}</td>
                        <td class="p-3">{{ lead.outcome }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="md:hidden space-y-4">
            {% for lead in leads %}
            <div class="bg-[#0D1321] border border-[#7B00FF] rounded-lg p-4 animate-fade-in" data-score="{{ lead.score }}" data-date="{{ lead.date_added }}" style="animation-delay: {{ loop.index0 * 0.1 }}s">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold">{{ lead.name }}</h3>
                    <span class="{% if lead.score > 75 %}text-[#7B00FF]{% endif %}">Score: {{ lead.score }}</span>
                </div>
                <p class="text-[#A1A9B8] text-sm mb-1">{{ lead.email }}</p>
                <p class="text-[#A1A9B8] text-sm mb-1">Source: {{ lead.source }}</p>
                <div class="flex justify-between text-sm mb-1">
                    <span>Status: {{ lead.status }}</span>
                    <span>{{ lead.date_added }}</span>
                </div>
                <p class="text-[#A1A9B8] text-sm mb-1">Notes: {{ lead.notes }}</p>
                <p class="text-[#A1A9B8] text-sm">Outcome: {{ lead.outcome }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Export Button -->
        <div class="mt-4 flex justify-center">
            <a href="{{ url_for('download_leads') }}" class="bg-[#7B00FF] text-white px-5 py-2 rounded-lg hover:bg-[#8F00FF] hover:shadow-lg transform hover:scale-105 transition-transform duration-200">
                Download All Leads (CSV)
            </a>
        </div>
    </div>
</div>

<script>
    let sortDirections = {};

    function sortTable(columnIndex) {
        const table = document.querySelector('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Toggle sort direction
        sortDirections[columnIndex] = !sortDirections[columnIndex];
        const direction = sortDirections[columnIndex] ? 1 : -1;

        const sortedRows = rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();

            if (columnIndex === 3) { // Score column
                return direction * (parseInt(aValue) - parseInt(bValue));
            } else if (columnIndex === 5) { // Date column
                return direction * (new Date(aValue) - new Date(bValue));
            } else {
                return direction * aValue.localeCompare(bValue);
            }
        });

        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }

    function filterLeads() {
        const timeFilter = document.getElementById('timeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const today = new Date();

        const rows = document.querySelectorAll('tbody tr, .md\\:hidden > div');
        rows.forEach(row => {
            let show = true;
            const isDesktop = row.tagName === 'TR';
            
            // Get values based on desktop/mobile layout
            const date = new Date(isDesktop ? 
                row.cells[5].textContent : 
                row.getAttribute('data-date')
            );
            const status = isDesktop ? 
                row.cells[4].textContent : 
                row.querySelector('span:nth-of-type(1)').textContent.replace('Status: ', '');
            const name = isDesktop ? 
                row.cells[0].textContent : 
                row.querySelector('h3').textContent;
            const email = isDesktop ? 
                row.cells[1].textContent : 
                row.querySelectorAll('p')[0].textContent;

            // Time filter
            if (timeFilter !== 'all') {
                const days = parseInt(timeFilter);
                const cutoff = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));
                show = show && date >= cutoff;
            }

            // Status filter
            if (statusFilter !== 'all') {
                show = show && status === statusFilter;
            }

            // Search filter
            if (searchTerm) {
                show = show && (
                    name.toLowerCase().includes(searchTerm) ||
                    email.toLowerCase().includes(searchTerm)
                );
            }

            row.style.display = show ? '' : 'none';
        });
    }
</script>

<style>
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fade-in 0.5s ease-out;
        animation-fill-mode: both;
    }
</style>
{% endblock %}