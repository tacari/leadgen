{% extends "dashboard_base.html" %}
{% block title %}Analytics{% endblock %}
{% block content %}
<div class="bg-[#0D1321] min-h-screen text-white p-8">
    <!-- Header -->
    <h1 class="text-4xl font-bold text-center mb-4 animate-fade-in">Lead Performance Analytics</h1>
    <p class="text-lg text-[#A1A9B8] italic text-center mb-12">Track your pipeline, measure success, optimize growth.</p>

    <!-- Filters & Controls -->
    <div class="sticky top-20 bg-[#0D1321] z-10 py-4">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-4 items-center">
            <select id="date-range" class="bg-[#0D1321] border border-[#7B00FF] rounded-lg px-4 py-2 text-[#A1A9B8] text-sm hover:bg-[#7B00FF] hover:text-white">
                <option>Last 7 Days</option>
                <option selected>Last 30 Days</option>
                <option>Last 90 Days</option>
                <option>All Time</option>
                <option>Custom</option>
            </select>
            <select id="status-filter" class="bg-[#0D1321] border border-[#7B00FF] rounded-lg px-4 py-2 text-[#A1A9B8] text-sm hover:bg-[#7B00FF] hover:text-white">
                <option>All</option>
                <option>Pending</option>
                <option>Emailed</option>
                <option>Replied</option>
                <option>Converted</option>
            </select>
            {% if source_insights %}
            <select id="source-filter" class="bg-[#0D1321] border border-[#7B00FF] rounded-lg px-4 py-2 text-[#A1A9B8] text-sm hover:bg-[#7B00FF] hover:text-white">
                <option>All</option>
                {% for source in source_insights.keys() %}
                <option>{{ source }}</option>
                {% endfor %}
            </select>
            {% endif %}
            <button id="reset-filters" class="border border-[#7B00FF] text-white px-5 py-2 rounded-lg hover:bg-[#7B00FF] hover:shadow-lg">Clear Filters</button>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 my-8">
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-4 text-center animate-fade-in">
            <p class="text-white text-2xl font-bold">{{ analytics.total_leads }}</p>
            <p class="text-[#A1A9B8] text-base">Total Leads</p>
        </div>
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-4 text-center animate-fade-in">
            <p class="text-white text-2xl font-bold">{{ analytics.emailed }}</p>
            <p class="text-[#A1A9B8] text-base">Emailed</p>
        </div>
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-4 text-center animate-fade-in">
            <p class="text-white text-2xl font-bold">{{ analytics.replies }}</p>
            <p class="text-[#A1A9B8] text-base">Replies</p>
        </div>
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-4 text-center animate-fade-in">
            <p class="text-white text-2xl font-bold">{{ analytics.conversions }}</p>
            <p class="text-[#A1A9B8] text-base">Conversions</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 animate-fade-in">
            <canvas id="leadsChart"></canvas>
            <div class="mt-4 flex gap-4 justify-center">
                <button class="time-toggle bg-[#7B00FF] text-white px-4 py-2 rounded-lg hover:bg-[#8F00FF]" data-period="day">Day</button>
                <button class="time-toggle bg-[#7B00FF] text-white px-4 py-2 rounded-lg hover:bg-[#8F00FF]" data-period="week">Week</button>
                <button class="time-toggle bg-[#7B00FF] text-white px-4 py-2 rounded-lg hover:bg-[#8F00FF]" data-period="month">Month</button>
            </div>
        </div>
        <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 animate-fade-in">
            <canvas id="statusChart" width="400" height="400"></canvas>
        </div>
    </div>

    <!-- Detailed Table & Insights -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
            <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 overflow-x-auto">
                <table class="w-full text-left text-[#A1A9B8] text-sm">
                    <thead>
                        <tr class="border-b border-[#7B00FF]">
                            <th class="p-3 cursor-pointer" onclick="sortTable('date')">Date</th>
                            <th class="p-3">Leads Added</th>
                            <th class="p-3">Emailed</th>
                            <th class="p-3">Replies</th>
                            <th class="p-3">Conversions</th>
                            <th class="p-3 cursor-pointer" onclick="sortTable('avg_score')">Avg Score</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-table">
                        {% for row in leads %}
                        <tr class="border-b border-[#7B00FF] animate-fade-in" data-date="{{ row.date_added }}" data-avg_score="{{ row.avg_score }}">
                            <td class="p-3">{{ row.date_added }}</td>
                            <td class="p-3 text-white">{{ row.leads_added }}</td>
                            <td class="p-3 text-white">{{ row.emailed }}</td>
                            <td class="p-3 text-white">{{ row.replies }}</td>
                            <td class="p-3 text-white">{{ row.conversions }}</td>
                            <td class="p-3 {% if row.avg_score > 75 %}text-[#7B00FF]{% endif %}">{{ row.avg_score }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Insights -->
        <div class="md:col-span-1">
            <div class="bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 animate-fade-in">
                <h2 class="text-xl font-bold text-white mb-4">Performance Insights</h2>
                <ul class="space-y-2 text-[#A1A9B8] text-sm">
                    {% if insights %}
                    <li>Top Source: {{ insights.top_source }}</li>
                    <li>Best Day: {{ insights.best_day }}</li>
                    <li>Conversion Rate: {{ insights.conversion_rate }}%</li>
                    {% endif %}
                </ul>
            </div>
            {% if source_insights %}
            <div class="mt-6 bg-[#1A2236] border border-[#7B00FF] rounded-lg p-6 animate-fade-in">
                <h2 class="text-xl font-bold text-white mb-4">Source Details</h2>
                <ul class="space-y-2">
                    {% for source, info in source_insights.items() %}
                    <li class="text-[#A1A9B8] text-sm">{{ source }}: {{ info.count }} leads, {{ info.high_score_percent }}% high-score</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Leads Over Time Bar Chart
    const leadsCtx = document.getElementById('leadsChart').getContext('2d');
    const leadsChart = new Chart(leadsCtx, {
        type: 'bar',
        data: {
            labels: {{ analytics.charts.dates | tojson }},
            datasets: [{
                label: 'Leads Added',
                data: {{ analytics.charts.daily | tojson }},
                backgroundColor: '#7B00FF',
                borderColor: '#8F00FF',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // Status Breakdown Pie Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: {{ analytics.charts.status.labels | tojson }},
            datasets: [{
                data: {{ analytics.charts.status.data | tojson }},
                backgroundColor: ['#A1A9B8', '#7B00FF', '#00BFFF', '#00FF7F']
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: 'right', 
                    labels: { 
                        color: '#FFFFFF' 
                    } 
                } 
            } 
        }
    });

    // Sorting for Table
    let sortDirection = {};
    function sortTable(column) {
        const tbody = document.getElementById('analytics-table');
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        sortDirection[column] = !sortDirection[column] || false;
        rows.sort((a, b) => {
            let aValue = a.dataset[column];
            let bValue = b.dataset[column];
            if (column === 'avg_score') {
                aValue = parseFloat(aValue);
                bValue = parseFloat(bValue);
            } else if (column === 'date') {
                aValue = new Date(aValue);
                bValue = new Date(bValue);
            }
            return sortDirection[column] ? aValue > bValue ? 1 : -1 : aValue < bValue ? 1 : -1;
        });
        rows.forEach(row => tbody.appendChild(row));
    }
</script>

<style>
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.5s ease-in; }
</style>
{% endblock %}